name: Deploy Static Site
description: Build and deploy a static site via SCP + Nginx reload
inputs:
  host:
    required: true
    description: SSH host
  username:
    required: true
    description: SSH username
  key:
    required: true
    description: SSH private key
  target_dir:
    required: true
    description: Remote directory to deploy to
  node_version:
    required: false
    default: '24'
  pnpm_version:
    required: false
    default: ''
  build_command:
    required: false
    default: 'pnpm build'
  output_dir:
    required: false
    default: 'out'
runs:
  using: composite
  steps:
    - uses: actions/checkout@v4
    - id: detect-pnpm-version
      shell: bash
      run: |
        VERSION="${{ inputs.pnpm_version }}"
        
        if [ -z "$VERSION" ] && [ -f "package.json" ]; then
          if grep -q '"packageManager"[[:space:]]*:[[:space:]]*"pnpm' package.json; then
            echo "Detected pnpm in packageManager, letting pnpm/action-setup handle it."
            VERSION=""
          else
            VERSION="latest"
          fi
        elif [ -z "$VERSION" ]; then
          VERSION="latest"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    - uses: pnpm/action-setup@v4
      with:
        version: ${{ steps.detect-pnpm-version.outputs.version }}
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version }}
        cache: pnpm
    - run: pnpm install --frozen-lockfile
      shell: bash
    - run: ${{ inputs.build_command }}
      shell: bash
    - uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ inputs.host }}
        username: ${{ inputs.username }}
        key: ${{ inputs.key }}
        source: "${{ inputs.output_dir }}/*"
        target: ${{ inputs.target_dir }}
        rm: true
    - uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ inputs.host }}
        username: ${{ inputs.username }}
        key: ${{ inputs.key }}
        script: |
          sudo nginx -t
          sudo systemctl reload nginx